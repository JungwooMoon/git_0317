<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>3D Ï∫êÎ¶≠ÌÑ∞ AR + Ïö©Ïñ¥ Ïù∏Ïãù</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: -1;
      }
      canvas {
        display: block;
      }
      button {
        position: absolute;
        z-index: 10;
        padding: 10px 16px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      #analyzeButton {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
      }
      #switchCameraButton {
        bottom: 20px;
        right: 10px;
        display: none;
      }
      #speechBubble {
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255,255,255,0.9);
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 16px;
        display: none;
        z-index: 15;
      }
      #loadingText {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 16px;
        display: none;
        z-index: 20;
      }
      button:hover {
        background-color: rgba(0, 0, 0, 0.9);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  </head>
  <body>
    <video id="webcam" autoplay muted playsinline></video>
    <button id="analyzeButton">üîç Ìï¥ÏÑù</button>
    <button id="switchCameraButton">üîÑ Ïπ¥Î©îÎùº Ï†ÑÌôò</button>
    <div id="speechBubble"></div>
    <div id="loadingText">Ìï¥ÏÑù Ï§ëÏûÖÎãàÎã§...</div>

    <script type="module">
      import * as THREE from 'https://esm.sh/three@0.158.0';
      import { GLTFLoader } from 'https://esm.sh/three@0.158.0/examples/jsm/loaders/GLTFLoader.js';

      const video = document.getElementById('webcam');
      const switchBtn = document.getElementById('switchCameraButton');
      const loadingText = document.getElementById('loadingText');
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      const glossary = {
        "ÎßåÍ∏∞ÏùºÏãúÏÉÅÌôò": "Îß§ÎÖÑ Ïù¥ÏûêÎßå ÎÇ¥Îã§Í∞Ä ÎßàÏßÄÎßâÏóê Ìïú Î≤àÏóê ÏõêÍ∏àÍ≥º Ïù¥ÏûêÎ•º Î™®Îëê Í∞öÎäî Î∞©ÏãùÏù¥ÏóêÏöî!",
        "ÏõêÍ∏àÍ∑†Îì±ÏÉÅÌôò": "Ï≤òÏùåÏóê ÎßéÏù¥ ÎÇ¥Í≥† Ï†êÏ†ê Ï†ÅÍ≤å ÎÇ¥Îäî Î∞©ÏãùÏù¥ÏóêÏöî. Ïù¥ÏûêÎäî Ï§ÑÏñ¥Îì§ÏßÄÎßå, Ï¥àÎ∞ò Î∂ÄÎã¥Ïù¥ Ïª§Ïöî.",
        "ÏõêÎ¶¨Í∏àÍ∑†Îì±ÏÉÅÌôò": "Îß§Îã¨ ÎπÑÏä∑Ìïú Í∏àÏï°ÏùÑ Í∞öÏïÑÏÑú Í≥ÑÏÇ∞Ïù¥ Ïâ¨ÏõåÏöî. ÌïòÏßÄÎßå Ï†ÑÏ≤¥Î°ú Î≥¥Î©¥ Í∞öÎäî ÎèàÏù¥ ÎßéÏùÑ Ïàò ÏûàÏñ¥Ïöî!",
        "Í∏àÎ¶¨": "ÎèàÏùÑ ÎπåÎ¶¥ Îïå, ÏñºÎßàÎÇò Îçî ÎÇ¥Ïïº ÌïòÎäîÏßÄÎ•º ÌçºÏÑºÌä∏(%)Î°ú ÎÇòÌÉÄÎÇ∏ Ïà´ÏûêÏòàÏöî.",
        "Í≥†Ï†ï Í∏àÎ¶¨": "Ï≤òÏùå Ï†ïÌïú Í∏àÎ¶¨Í∞Ä ÎÅùÎÇ† ÎïåÍπåÏßÄ Î≥ÄÌïòÏßÄ ÏïäÏïÑÏöî. ÎßàÏùåÏù¥ Ìé∏ÏïàÌïòÏ£†!",
        "Î≥ÄÎèô Í∏àÎ¶¨": "Í∏àÎ¶¨Í∞Ä Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú Î∞îÎÄåÏñ¥Ïöî. Í≤ΩÏ†ú ÌùêÎ¶ÑÏóê Îî∞Îùº Ïù¥ÏûêÍ∞Ä Îäò ÏàòÎèÑ, Ï§Ñ ÏàòÎèÑ ÏûàÏñ¥Ïöî."
      };

      let currentFacing = 'environment';
      let stream = null;

      async function setupCamera(facingMode = 'user') {
        if (stream) stream.getTracks().forEach((track) => track.stop());

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: isMobile ? { facingMode: { exact: facingMode } } : true,
            audio: false,
          });
          video.srcObject = stream;
          currentFacing = facingMode;
        } catch (err) {
          console.error('Ïπ¥Î©îÎùº Ïó∞Í≤∞ Ïã§Ìå®:', err);
        }
      }

      if (isMobile) {
        switchBtn.style.display = 'block';
        switchBtn.addEventListener('click', () => {
          const nextFacing = currentFacing === 'user' ? 'environment' : 'user';
          setupCamera(nextFacing);
        });
      }

      setupCamera(isMobile ? currentFacing : 'user');

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 2;

      const renderer = new THREE.WebGLRenderer({ alpha: true, preserveDrawingBuffer: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 1, 2).normalize();
      scene.add(light);

      const loader = new GLTFLoader();
      let model;

      loader.load('honey.glb', (gltf) => {
        model = gltf.scene;
        model.scale.set(0.5, 0.5, 0.5);
        scene.add(model);
      }, undefined, (err) => {
        console.error('Î™®Îç∏ Î°úÎìú Ïã§Ìå®:', err);
      });

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }

      animate();

      document.getElementById('analyzeButton').addEventListener('click', async () => {
        loadingText.style.display = 'block';
        try {
          const width = renderer.domElement.width;
          const height = renderer.domElement.height;

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');

          ctx.drawImage(video, 0, 0, width, height);
          ctx.drawImage(renderer.domElement, 0, 0, width, height);

          const { data: { text } } = await Tesseract.recognize(canvas, 'eng+kor');
          console.log('Ïù∏ÏãùÎêú ÌÖçÏä§Ìä∏:', text);

          const foundWord = Object.keys(glossary).find((word) => text.includes(word));
          if (foundWord) {
            const bubble = document.getElementById('speechBubble');
            bubble.innerText = glossary[foundWord];
            bubble.style.display = 'block';
            setTimeout(() => { bubble.style.display = 'none'; }, 5000);
          } else {
            alert('ÏÑ§Î™ÖÌï† Îã®Ïñ¥Î•º Ï∞æÏßÄ Î™ªÌñàÏñ¥Ïöî.');
          }
        } catch (err) {
          console.error('OCR ÏóêÎü¨:', err);
          alert('Ìï¥ÏÑù Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî.');
        } finally {
          loadingText.style.display = 'none';
        }
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
